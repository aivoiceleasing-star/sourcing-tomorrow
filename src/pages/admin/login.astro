---
export const prerender = false;

import { checkPassword, createSessionToken, COOKIE_NAME, MAX_AGE } from '../../lib/auth';

let error = '';

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const password = formData.get('password')?.toString() || '';

  if (checkPassword(password)) {
    const token = createSessionToken();
    Astro.cookies.set(COOKIE_NAME, token, {
      path: '/',
      httpOnly: true,
      secure: import.meta.env.PROD,
      sameSite: 'lax',
      maxAge: MAX_AGE,
    });
    return Astro.redirect('/admin');
  }
  error = 'Invalid password';
}
---

<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex, nofollow" />
  <title>Admin Login | SourcingTomorrow</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      min-height: 100vh;
      display: flex;
      background: #fafbfc;
      -webkit-font-smoothing: antialiased;
    }
    .login-wrapper { display: flex; width: 100%; min-height: 100vh; }
    .brand-panel {
      flex: 1;
      background: linear-gradient(135deg, #115e59 0%, #0f766e 40%, #14b8a6 70%, #2dd4bf 100%);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      padding: 3rem; position: relative; overflow: hidden;
    }
    .brand-panel::before {
      content: ''; position: absolute; top: -30%; right: -20%;
      width: 500px; height: 500px; background: rgba(255,255,255,0.06); border-radius: 50%;
    }
    .brand-panel::after {
      content: ''; position: absolute; bottom: -20%; left: -10%;
      width: 400px; height: 400px; background: rgba(255,255,255,0.04); border-radius: 50%;
    }
    .brand-content { position: relative; z-index: 1; text-align: center; max-width: 400px; }
    .brand-icon {
      width: 80px; height: 80px; background: rgba(255,255,255,0.15);
      border-radius: 24px; display: flex; align-items: center; justify-content: center;
      margin: 0 auto 2rem; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2);
    }
    .brand-icon svg { width: 40px; height: 40px; color: white; }
    .brand-title { font-size: 2rem; font-weight: 800; color: white; letter-spacing: -0.03em; margin-bottom: 0.75rem; }
    .brand-subtitle { font-size: 1.05rem; color: rgba(255,255,255,0.8); line-height: 1.6; }
    .brand-features { margin-top: 2.5rem; display: flex; flex-direction: column; gap: 1rem; }
    .brand-feature { display: flex; align-items: center; gap: 0.75rem; color: rgba(255,255,255,0.85); font-size: 0.9rem; font-weight: 500; }
    .feature-dot { width: 8px; height: 8px; background: rgba(255,255,255,0.6); border-radius: 50%; flex-shrink: 0; }
    .form-panel { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 3rem; max-width: 560px; }
    .form-container { width: 100%; max-width: 380px; }
    .form-header { margin-bottom: 2.5rem; }
    .form-header h1 { font-size: 1.75rem; font-weight: 800; color: #111827; letter-spacing: -0.03em; margin-bottom: 0.5rem; }
    .form-header p { color: #6b7280; font-size: 0.95rem; }
    .error-msg {
      background: #fef2f2; border: 1px solid #fecaca; color: #dc2626;
      padding: 0.75rem 1rem; border-radius: 12px; font-size: 0.875rem; font-weight: 500;
      margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;
    }
    .input-group { margin-bottom: 1.25rem; }
    .input-group label { display: block; font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem; }
    .input-wrapper { position: relative; }
    .input-wrapper input {
      width: 100%; padding: 0.875rem 1rem 0.875rem 3rem; background: #f3f4f6;
      border: 2px solid transparent; border-radius: 14px; font-size: 0.95rem; color: #111827;
      transition: all 0.2s ease; font-family: inherit;
    }
    .input-wrapper input:focus { outline: none; background: #fff; border-color: #14b8a6; box-shadow: 0 0 0 4px rgba(20, 184, 166, 0.12); }
    .input-wrapper input::placeholder { color: #9ca3af; }
    .input-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #9ca3af; pointer-events: none; transition: color 0.2s; }
    .input-wrapper input:focus ~ .input-icon { color: #14b8a6; }
    .toggle-password { position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); background: none; border: none; color: #9ca3af; cursor: pointer; padding: 4px; transition: color 0.2s; }
    .toggle-password:hover { color: #374151; }
    .submit-btn {
      width: 100%; padding: 0.9rem;
      background: linear-gradient(135deg, #0f766e, #14b8a6);
      color: white; border: none; border-radius: 14px; font-size: 1rem; font-weight: 700;
      cursor: pointer; transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(15, 118, 110, 0.35), 0 1px 3px rgba(0,0,0,0.06);
      font-family: inherit; letter-spacing: -0.01em; margin-top: 0.5rem;
    }
    .submit-btn:hover { background: linear-gradient(135deg, #115e59, #0f766e); box-shadow: 0 6px 20px rgba(15, 118, 110, 0.45), 0 2px 6px rgba(0,0,0,0.08); transform: translateY(-2px); }
    .submit-btn:active { transform: translateY(0); }
    .back-link { display: block; text-align: center; margin-top: 2rem; color: #9ca3af; font-size: 0.85rem; text-decoration: none; transition: color 0.2s; }
    .back-link:hover { color: #14b8a6; }
    @media (max-width: 768px) {
      .login-wrapper { flex-direction: column; }
      .brand-panel { padding: 2rem 1.5rem; min-height: auto; }
      .brand-features { display: none; }
      .brand-title { font-size: 1.5rem; }
      .brand-subtitle { font-size: 0.9rem; }
      .form-panel { max-width: 100%; padding: 2rem 1.5rem; }
    }
  </style>
</head>
<body>
  <div class="login-wrapper">
    <div class="brand-panel">
      <div class="brand-content">
        <div class="brand-icon">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 0 0 8.716-6.747M12 21a9.004 9.004 0 0 1-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 0 1 7.843 4.582M12 3a8.997 8.997 0 0 0-7.843 4.582m15.686 0A11.953 11.953 0 0 1 12 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0 1 21 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0 1 12 16.5c-3.162 0-6.133-.815-8.716-2.247m0 0A9.015 9.015 0 0 1 3 12c0-1.605.42-3.113 1.157-4.418" />
          </svg>
        </div>
        <h2 class="brand-title">SourcingTomorrow</h2>
        <p class="brand-subtitle">Content management dashboard for the SourcingTomorrow procurement community.</p>
        <div class="brand-features">
          <div class="brand-feature"><span class="feature-dot"></span> Manage articles & insights</div>
          <div class="brand-feature"><span class="feature-dot"></span> Track contact submissions</div>
          <div class="brand-feature"><span class="feature-dot"></span> Publish resources & guides</div>
          <div class="brand-feature"><span class="feature-dot"></span> Monitor newsletter growth</div>
        </div>
      </div>
    </div>

    <div class="form-panel">
      <div class="form-container">
        <div class="form-header">
          <h1>Welcome back</h1>
          <p>Sign in to access the admin dashboard</p>
        </div>

        {error && (
          <div class="error-msg">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
            {error}
          </div>
        )}

        <form method="POST">
          <div class="input-group">
            <label for="password">Password</label>
            <div class="input-wrapper">
              <input type="password" id="password" name="password" placeholder="Enter admin password" required autofocus />
              <svg class="input-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>
              </svg>
              <button type="button" class="toggle-password" onclick="toggleVisibility()" aria-label="Toggle password visibility">
                <svg id="eye-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>
                </svg>
              </button>
            </div>
          </div>
          <button type="submit" class="submit-btn">Sign In</button>
        </form>

        <a href="/" class="back-link">&larr; Back to website</a>
      </div>
    </div>
  </div>

  <script is:inline>
    function toggleVisibility() {
      const input = document.getElementById('password');
      const icon = document.getElementById('eye-icon');
      if (input.type === 'password') {
        input.type = 'text';
        icon.innerHTML = '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/>';
      } else {
        input.type = 'password';
        icon.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>';
      }
    }
  </script>
</body>
</html>
